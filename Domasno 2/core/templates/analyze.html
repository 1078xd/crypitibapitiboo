{% extends "base.html" %}
{% block body_class %}analyze-bg{% endblock %}

{% block content %}
<section class="market-section">
  <div class="market-card">

    <h2 style="margin-bottom:12px;">Market Analysis</h2>

    <!-- CONTROLS -->
    <form method="get"
          style="display:flex; gap:16px; margin-bottom:16px; flex-wrap:wrap; align-items:center;">

      <!-- SEARCH -->
      <input
        type="text"
        name="search"
        placeholder="Search coin (e.g. BTC)"
        value="{{ search }}"
        style="padding:6px 10px; border-radius:6px; border:none;"
      />

      <!-- SORT -->
      <label>
        Sort:
        <select name="sort" onchange="this.form.submit()">
          <option value="asc" {% if sort == "asc" %}selected{% endif %}>Ascending</option>
          <option value="desc" {% if sort == "desc" %}selected{% endif %}>Descending</option>
        </select>
      </label>

      <!-- SIGNAL FILTER -->
      <label>
        Signal:
        <select name="signal" onchange="this.form.submit()">
          <option value="all" {% if signal_filter == "all" %}selected{% endif %}>All</option>
          <option value="buy" {% if signal_filter == "buy" %}selected{% endif %}>BUY</option>
          <option value="hold" {% if signal_filter == "hold" %}selected{% endif %}>HOLD</option>
          <option value="sell" {% if signal_filter == "sell" %}selected{% endif %}>SELL</option>
        </select>
      </label>

      <!-- SUBMIT -->
      <button type="submit"
              style="padding:6px 14px; border-radius:6px; border:none; cursor:pointer;">
        Search
      </button>

      <!-- RESET -->
      <a href="{% url 'analyze' %}"
         style="color:white; opacity:0.7; margin-left:8px;">
        Reset
      </a>

    </form>

    <!-- TABLE HEADER -->
    <div class="market-header" style="grid-template-columns: 0.3fr 1fr 0.6fr;">
      <div>#</div>
      <div>Coin</div>
      <div>Signal</div>
    </div>

    <!-- TABLE ROWS -->
    {% for r in page_obj %}
      <div class="market-row" style="grid-template-columns: 0.3fr 1fr 0.6fr;">
        <div>{{ forloop.counter0|add:page_obj.start_index }}</div>

        <div>
          <a href="{% url 'symbol_detail' r.symbol %}"
             style="color:white; text-decoration:none; font-weight:600;">
            {{ r.symbol }}
          </a>
        </div>

        <div class="signal {{ r.combined_signal|lower }}">
          {{ r.combined_signal }}
        </div>
      </div>
    {% empty %}
      <p style="margin-top:20px; opacity:0.7;">No matching coins found.</p>
    {% endfor %}

    <!-- PAGINATION -->
    <div style="margin-top:20px; text-align:center;">
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}&sort={{ sort }}&signal={{ signal_filter }}&search={{ search }}"
           style="color:white;">Previous</a>
      {% endif %}

      <span style="margin:0 12px;">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
      </span>

      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&sort={{ sort }}&signal={{ signal_filter }}&search={{ search }}"
           style="color:white;">Next</a>
      {% endif %}
    </div>

  </div>
</section>
{% endblock %}
